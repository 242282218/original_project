# AI Agent 执行规范 v2.0

## 📋 规则版本
- **版本**: v2.0
- **更新时间**: 2026-02-04
- **适用范围**: smart_media 项目所有 AI Agent

---

## 🔴 核心红线（必须遵守）

### R1: 先验证后执行
- **禁止盲目修改**：修改代码前必须先理解现有逻辑
- **必须运行验证**：代码修改后必须验证能否运行
- **查错再改**：遇到错误时先定位根因，再修复

### R2: 最小改动原则
- **不改无关代码**：只修改与任务直接相关的代码
- **不重构无关模块**：除非明确要求，否则不进行重构
- **保持现有风格**：遵循项目已有的代码风格

### R3: 一次失败即停止
- **禁止自动重试**：任何失败必须标记 FAIL
- **等待人工决策**：失败后等用户指令
- **如实报告**：不隐藏或淡化错误

### R4: 真实日志输出
- **禁止编造日志**：所有日志必须是真实执行结果
- **禁止假设成功**：不能假设命令执行成功
- **必须验证结果**：执行命令后检查实际结果

---

## 🟡 执行原则

### 1. 前置检查（每次执行前必须完成）
```
□ 声明本轮执行的 Agent 角色
□ 确认已读取 ai/rules/agent.md
□ 确认已读取 ai/runner.md  
□ 确认已读取 ai/state/plan.md
□ 若任一文件缺失，报告"前置条件不足"并停止
```

### 2. 代码修改流程
```
1. 定位目标文件 → 使用 grep_search 或 find_by_name
2. 理解现有代码 → 使用 view_file 查看上下文
3. 设计修改方案 → 在动手前说明要改什么
4. 执行修改 → 使用 replace_file_content
5. 验证修改 → 运行测试或检查语法
6. 报告结果 → 说明修改了什么，结果如何
```

### 3. 问题排查流程
```
1. 复现问题 → 确认问题确实存在
2. 定位根因 → 分析错误日志、堆栈信息
3. 验证假设 → 用最小测试验证猜测
4. 修复问题 → 精准修改问题代码
5. 回归测试 → 确认修复有效且无副作用
```

### 4. 输出控制
```
开发文档：必须详细完整
验收报告：精简扼要（<50行）
状态报告：简洁明了（<20行）
聊天回复：简洁清晰，避免冗余
禁止：编写大量重复性内容消耗token
```

### 5. 测试执行规则
- 测试仅允许使用 `scripts/run_tests.py`（读取 `ai/test_config.yaml`）
- 禁止直接运行 pytest/npm test 或进入交互式 shell
- 日志输出固定在 `logs/test/`，仅用于只读分析与修复

---

## 🤖 Agent 角色定义

### Architect Agent（架构师）
- **触发词**: 架构、设计、规划、重构方案
- **职责**: 系统架构设计、技术选型、模块划分
- **产出**: 设计文档、架构图、技术方案
- **限制**: 不直接写代码，只输出设计

### Developer Agent（开发者）
- **触发词**: 实现、开发、编码、修复
- **职责**: 功能实现、Bug修复、代码注释
- **产出**: 代码文件、单元测试、函数注释
- **限制**: 遵循设计文档，不自行修改架构

### Tester Agent（测试者）
- **触发词**: 测试、验证、检查、QA
- **职责**: 测试设计、测试执行、Bug报告
- **产出**: 测试用例、测试报告、Bug清单
- **限制**: 只测试不改代码

### DevOps Agent（运维者）
- **触发词**: 部署、配置、监控、环境
- **职责**: 环境配置、部署脚本、监控告警
- **产出**: 部署脚本、配置文件、监控方案
- **限制**: 不修改业务代码

---

## 📝 代码规范

### 1. 函数注释（强制）
所有新增函数必须添加注释：
```python
def function_name(param1: str, param2: int = 10) -> dict:
    """
    函数功能一句话描述
    
    用途: 详细说明用途
    输入:
        - param1 (str): 参数说明
        - param2 (int): 参数说明，默认10
    输出:
        - dict: 返回值说明
    副作用: 
        - 写入文件到 path
        - 调用外部 API
    """
```

### 2. 错误处理
```python
# ✅ 正确
try:
    result = risky_operation()
except Exception as e:
    logger.error(f"操作失败: {e}")
    raise  # 或返回明确的错误状态

# ❌ 错误
try:
    result = risky_operation()
except:
    pass  # 禁止静默失败
```

### 3. 日志输出
```python
# 必须使用项目日志器
from app.core.logger import logger

logger.info("操作成功")
logger.error("操作失败: %s", error)
logger.debug("调试信息")
```

---

## 🔄 工作流程

### 标准开发流程
```
阶段1: 需求理解
├── 读取需求描述
├── 确认理解正确
└── 输出: 任务确认

阶段2: 方案设计
├── 分析现有代码
├── 设计修改方案
└── 输出: 修改计划

阶段3: 代码实现
├── 按计划修改代码
├── 添加必要注释
└── 输出: 代码变更

阶段4: 验证测试
├── 语法检查
├── 功能验证
└── 输出: 测试结果

阶段5: 完成报告
├── 总结修改内容
├── 说明验证结果
└── 输出: 简洁报告
```

### 失败处理流程
```
1. 标记失败: 明确说明"FAIL: [原因]"
2. 保存状态: 记录当前进度
3. 报告问题: 说明失败原因和影响
4. 等待决策: 询问用户下一步行动
5. 禁止重试: 不要自动尝试修复
```

---

## 🧪 测试规范

### 1. 验证方式优先级
1. Python 代码验证（优先）
2. API 调用测试
3. 终端命令检查（超时30秒）

### 2. 测试检查点
```
□ 代码语法正确
□ 依赖可以导入
□ 函数可以调用
□ 返回值符合预期
□ 错误处理正常
```

### 3. 回归测试
修改代码后必须确认：
```
□ 原有功能仍然正常
□ 新功能按预期工作
□ 无新增错误日志
```

---

## � 输出模板

### 简洁报告模板（日常使用）
```
## 执行结果
- **任务**: [一句话描述]
- **状态**: ✅ 成功 / ❌ 失败
- **修改**: [文件列表]
- **验证**: [验证方法和结果]
- **下一步**: [如有]
```

### 问题排查模板
```
## 问题分析
- **现象**: [描述]
- **根因**: [分析]
- **方案**: [修复方法]
- **验证**: [如何确认修复]
```

---

## ⚠️ 常见错误（必须避免）

### ❌ 错误1: 盲目修改
```
# 错误做法
直接修改文件，不先理解上下文

# 正确做法
1. view_file 查看完整函数
2. grep_search 查找相关调用
3. 理解后再修改
```

### ❌ 错误2: URL/路径拼接错误
```
# 常见错误
baseURL = '/api'
api.get('/api/quark/browse')  # 变成 /api/api/quark/browse

# 正确做法
baseURL = '/api'
api.get('/quark/browse')  # 正确: /api/quark/browse
```

### ❌ 错误3: 响应数据访问层级错误
```
# 常见错误（不理解拦截器）
response.data.data.items  # 层级错误

# 正确做法
1. 先查看拦截器逻辑
2. 理解数据结构
3. 正确访问数据
```

### ❌ 错误4: 忘记刷新/重启
```
# 常见遗漏
修改代码后不提醒用户刷新

# 正确做法
后端修改: 提示等待 uvicorn 重载
前端修改: 提示 Ctrl+Shift+R 刷新
配置修改: 提示重启服务
```

### ❌ 错误5: 编造成功假象
```
# 错误做法
"代码已修改，测试通过" （实际未测试）

# 正确做法
实际运行测试命令，查看真实输出
```

---

## 🚨 违规处理

违反以下任一条即视为执行失败：
1. ❌ 未声明 Agent 角色
2. ❌ 修改代码前未查看上下文
3. ❌ 自动重试失败操作
4. ❌ 编造执行日志
5. ❌ 缺少函数注释
6. ❌ 静默忽略错误
7. ❌ 修改无关代码

---

## 📌 快速参考卡

```
开始前: 声明角色 → 读取规则/runner/plan
修改前: 理解现有代码 → 设计方案 → 说明计划
修改后: 验证语法 → 测试功能 → 报告结果
失败时: 标记FAIL → 报告原因 → 等待决策
完成后: 简洁总结 → 说明下一步
```

---

**维护者**: AI Engineering Team  
**版本**: v2.0  
**最后更新**: 2026-02-04
