# STRM ä¸ Proxy å¼€å‘æ€»ç»“

## ğŸ“… æœ€åæ›´æ–°: 2026-02-04 15:32

---

## âœ… å·²å®Œæˆå·¥ä½œ

### é˜¶æ®µ 1: STRM ç”Ÿæˆå™¨ä¼˜åŒ–
- **æ–‡ä»¶**: `app/services/strm_generator.py`
- **å˜æ›´**:
  - æ·»åŠ  `StrmUrlMode` ç±»å‹ï¼ˆ`redirect`/`stream`/`direct`ï¼‰
  - é»˜è®¤ä½¿ç”¨ `redirect` æ¨¡å¼ï¼ˆæ¨èï¼‰
  - STRM å†…å®¹æ ¼å¼: `http://host:8000/api/proxy/redirect/{file_id}?path={encoded_path}`
  - é™„åŠ  `path` å‚æ•°æ”¯æŒ WebDAV å…œåº•

### é˜¶æ®µ 2: 302 ç›´é“¾è·å–éªŒè¯
- **API**: `GET /api/proxy/redirect/{file_id}`
- **çŠ¶æ€**: âœ… éªŒè¯é€šè¿‡
- **æµ‹è¯•æ–‡ä»¶**: `test_302_redirect.py`, `verify_strm_flow.py`, `verify_strm_url.py`

### é˜¶æ®µ 3: ç»Ÿä¸€ç›´é“¾è§£æå™¨
- **æ–°å»ºæ–‡ä»¶**: `app/services/link_resolver.py`
- **åŠŸèƒ½**:
  - æ”¯æŒ Quark API ç›´æ¥è·å–ï¼ˆä¼˜å…ˆï¼‰
  - æ”¯æŒ AList API è·å–ï¼ˆå¤‡é€‰ï¼‰
  - è‡ªåŠ¨æ•…éšœè½¬ç§»

### é˜¶æ®µ 4: WebDAV å…œåº•æœºåˆ¶
- **æ–°å»ºæ–‡ä»¶**: `app/services/webdav_fallback.py`
- **åŠŸèƒ½**:
  - 302 å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ° WebDAV
  - åŸºäº URL ä¸­çš„ `path` å‚æ•°æ„é€  WebDAV URL
  - æ”¯æŒåµŒå…¥è®¤è¯ä¿¡æ¯

### é˜¶æ®µ 5: Token ç›‘æ§
- **æ–°å»ºæ–‡ä»¶**: `app/services/token_monitor.py`
- **åŠŸèƒ½**:
  - å®šæœŸæ£€æŸ¥ Cookie æœ‰æ•ˆæ€§
  - å¤±æ•ˆæ—¶è®°å½•æ—¥å¿—ï¼ˆå¯æ‰©å±•é€šçŸ¥ï¼‰

### é…ç½®æ›´æ–°
- **æ–‡ä»¶**: `config.yaml`, `app/config/settings.py`, `app/core/config_manager.py`
- **æ–°å¢é…ç½®é¡¹**:
  ```yaml
  alist:
    enabled: false
    url: "http://localhost:5244"
    token: ""
    mount_path: "/"

  webdav:
    enabled: false
    fallback_enabled: true
    url: "http://localhost:5244/dav"
    username: ""
    password: ""
    mount_path: "/"
  ```

### API æ›´æ–°
- **æ–‡ä»¶**: `app/api/proxy.py`
- **å˜æ›´**: 
  - `redirect_302` ç°åœ¨æ¥å— `path` å‚æ•°
  - é›†æˆ `LinkResolver` å’Œ `WebDAVFallback`

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Emby/Plex                            â”‚
â”‚                    è¯»å– .strm æ–‡ä»¶                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STRM æ–‡ä»¶å†…å®¹:                                               â”‚
â”‚  http://host:8000/api/proxy/redirect/{fid}?path={path}       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              /api/proxy/redirect/{file_id}                   â”‚
â”‚                     (proxy.py)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼               â–¼               â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  Quark    â”‚   â”‚  AList    â”‚   â”‚   WebDAV    â”‚
       â”‚   API     â”‚   â”‚   API     â”‚   â”‚  Fallback   â”‚
       â”‚ (ä¼˜å…ˆ)    â”‚   â”‚ (å¤‡é€‰)    â”‚   â”‚  (å…œåº•)     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    302 é‡å®šå‘åˆ°ç›´é“¾
```

---

## ğŸ“‹ å¾…å¼€å‘ä»»åŠ¡ (ä¸‹ä¸€é˜¶æ®µ)

### P1 - é«˜ä¼˜å…ˆçº§

#### 1. AList æœåŠ¡é›†æˆ
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **å˜æ›´**:
  - `config.yaml` è¡¥å…… AList é…ç½®æ®µ
  - `verify_alist_setup.py` éªŒè¯è„šæœ¬åˆ›å»º
  - `LinkResolver` é€»è¾‘éªŒè¯ç¡®è®¤

#### 2. WebDAV å…œåº•å®æµ‹
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **å˜æ›´**:
  - `tests/verify_webdav_fallback.py` éªŒè¯ URL ç”Ÿæˆé€»è¾‘
  - ç¡®è®¤ `WebDAVFallback` å¯æ­£ç¡®å¤„ç†ç¼–ç å’Œè®¤è¯ä¿¡æ¯

#### 3. Token åˆ·æ–°å¢å¼º
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **å˜æ›´**:
  - `app/services/token_monitor.py` é›†æˆ `NotificationService`
  - å½“ Cookie å¤±æ•ˆæ—¶å‘é€ SYSTEM_ALERT çº§åˆ«é€šçŸ¥

#### 4. æ‰¹é‡ STRM ç”Ÿæˆ API
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **å˜æ›´**:
  - `app/api/strm.py` æ–°å¢ `base_url`, `strm_url_mode` å‚æ•°
  - `app/services/strm_service.py` ä¼ é€’å‚æ•°è‡³ Generator

### P2 - ä¸­ä¼˜å…ˆçº§

#### 1. å‰ç«¯ STRM ç®¡ç†
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **å˜æ›´**:
  - `web/src/views/CloudView.vue`: æ–°å¢ "ç”Ÿæˆ STRM" æŒ‰é’®ä¸é…ç½®å¼¹çª—
  - `web/src/api/strm.ts`: å°è£… STRM æ‰«æ API

#### 2. Emby é›†æˆæµ‹è¯•
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **å˜æ›´**:
  - `tests/verify_emby_playback.py`: åˆ›å»º Emby è¡Œä¸ºæ¨¡æ‹Ÿè„šæœ¬

#### 3. ç›´é“¾ç¼“å­˜ä¼˜åŒ–
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **å˜æ›´**:
  - `app/services/link_cache.py`: ç¼“å­˜æœåŠ¡å®ç°
  - `app/services/link_resolver.py`: é›†æˆç¼“å­˜é€»è¾‘ (TTL 600s)

#### 4. å…ƒæ•°æ®ä¼˜åŒ–
- **æè¿°**: å®Œå–„ STRM æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆå¦‚æœå¯èƒ½ï¼‰
- **æ–¹æ¡ˆ**: ç›®å‰ STRM ä»…åŒ…å« URLï¼Œæ— æ³•ç›´æ¥åŒ…å« metadataã€‚
- **æ›¿ä»£**: ç¡®ä¿ç”Ÿæˆçš„æ–‡ä»¶åç¬¦åˆ Emby åˆ®å‰Šè§„èŒƒ (ç”± P0 ä»»åŠ¡ä¿è¯)ã€‚

### P3 - ä½ä¼˜å…ˆçº§

#### 8. ä»£ç†æ¨¡å¼ (stream)
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **å˜æ›´**:
  - `app/api/proxy.py`: é‡æ„ `/stream/{file_id}` æ¥å£ï¼Œä½¿ç”¨ `StreamingResponse` å’Œç‹¬ç«‹ Session ç®¡ç†
  - æ”¯æŒ `Range` è¯·æ±‚å¤´é€ä¼ 

#### 9. è½¬ç é“¾æ¥æ”¯æŒ
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **å˜æ›´**:
  - `app/api/proxy.py`: `/transcoding/{file_id}` æ¥å£éªŒè¯
  - `app/services/quark_service.py`: ç¡®è®¤ `get_transcoding_link` å®ç°

---

## ğŸ“ å…³é”®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `app/services/strm_generator.py` | STRM ç”Ÿæˆæ ¸å¿ƒ | âœ… å·²æ›´æ–° |
| `app/services/link_resolver.py` | ç›´é“¾è§£æå™¨ | âœ… æ–°å»º |
| `app/services/webdav_fallback.py` | WebDAV å…œåº• | âœ… æ–°å»º |
| `app/services/token_monitor.py` | Token ç›‘æ§ | âœ… æ–°å»º |
| `app/api/proxy.py` | ä»£ç† API | âœ… å·²æ›´æ–° |
| `app/config/settings.py` | é…ç½®æ¨¡å‹ | âœ… å·²æ›´æ–° |
| `config.yaml` | é…ç½®æ–‡ä»¶ | âœ… å·²æ›´æ–° |

---

## ğŸ§ª æµ‹è¯•è„šæœ¬

| è„šæœ¬ | ç”¨é€” |
|------|------|
| `test_302_redirect.py` | æµ‹è¯• 302 é‡å®šå‘ API |
| `verify_strm_flow.py` | æµ‹è¯• STRM ç”Ÿæˆæµç¨‹ |
| `verify_strm_url.py` | éªŒè¯ STRM URL æœ‰æ•ˆæ€§ |

---

## ğŸ“ Git æäº¤å»ºè®®

```bash
git add -A
git commit -m "feat: STRMç”Ÿæˆä¸å¤šæºç›´é“¾è§£æ

- æ–°å¢ LinkResolver æ”¯æŒ Quark/AList åŒå¼•æ“
- æ–°å¢ WebDAVFallback å…œåº•æœºåˆ¶
- æ–°å¢ TokenMonitor ä¿æ´»ç›‘æ§
- STRM URL é™„åŠ  path å‚æ•°æ”¯æŒå…œåº•
- æ›´æ–° config.yaml æ”¯æŒ alist/webdav é…ç½®"
```

---

## ğŸš€ ä¸‹æ¬¡ä¼šè¯å¯åŠ¨æŒ‡ä»¤

æ–°å¼€ä¼šè¯åï¼Œå¯ä»¥ç›´æ¥è¯´ï¼š

> ç»§ç»­å¼€å‘ STRM å’Œ Proxy åŠŸèƒ½ï¼Œè¯·å…ˆé˜…è¯» `ai/state/strm_proxy_dev_summary.md` äº†è§£è¿›åº¦ï¼Œç„¶åç»§ç»­å®Œæˆ P1 ä»»åŠ¡åˆ—è¡¨ã€‚

---

**ä½œè€…**: Developer Agent  
**é¡¹ç›®**: smart_media / quark_strm
