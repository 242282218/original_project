# STRM ç”Ÿæˆä¸æ’­æ”¾é“¾è·¯å®ç°è®¡åˆ’

## ğŸ“‹ è®¡åˆ’ä¿¡æ¯
- **ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¶é—´**: 2026-02-04
- **ä¼˜å…ˆçº§**: P0ï¼ˆæœ€é«˜ï¼‰
- **çŠ¶æ€**: å¾…æ‰§è¡Œ

---

## ğŸ¯ ç›®æ ‡

å®ç°å®Œæ•´çš„ STRM ç”Ÿæˆå’Œæ’­æ”¾é“¾è·¯ï¼Œæ”¯æŒï¼š
1. ç”ŸæˆåŸºäºæœ¬åœ°ä»£ç† URL çš„ STRM æ–‡ä»¶
2. 302 ç›´é“¾æ’­æ”¾ï¼ˆä¼˜å…ˆï¼‰
3. WebDAV å…œåº•æ’­æ”¾ï¼ˆ302 å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢ï¼‰

---

## ğŸ“Š éœ€æ±‚ç¡®è®¤

### å·²ç¡®è®¤éœ€æ±‚
| ç±»åˆ« | ç¡®è®¤é¡¹ |
|------|--------|
| STRM å†…å®¹æ ¼å¼ | æœ¬åœ° 302 ä»£ç† URLï¼ˆ`http://host:8000/api/proxy/redirect/{file_id}`ï¼‰ |
| STRM ç›®å½•ç»“æ„ | ä¿æŒå¤¸å…‹ç›®å½•ç»“æ„ä¸å˜ |
| æ’­æ”¾é“¾è·¯ä¼˜å…ˆçº§ | 302 ç›´é“¾ > WebDAV å…œåº• |
| ç›´é“¾è·å–æ–¹å¼ | æ”¯æŒ AList API + å¤¸å…‹ API ä¸¤ç§ |
| Token åˆ·æ–° | å¿…é¡»æ”¯æŒè‡ªåŠ¨åˆ·æ–° |
| WebDAV å…œåº• | å•ç‹¬æ¨¡å—ï¼Œ302 å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢ |

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ’­æ”¾é“¾è·¯æµç¨‹

```
Emby è¯»å– STRM æ–‡ä»¶
        â”‚
        â–¼
STRM å†…å®¹: http://host:8000/api/proxy/redirect/{file_id}
        â”‚
        â–¼
åç«¯ /api/proxy/redirect/{file_id}
        â”‚
        â”œâ”€â”€ å°è¯•è·å– 302 ç›´é“¾
        â”‚   â”œâ”€â”€ ä¼˜å…ˆ: å¤¸å…‹ API ç›´æ¥è·å–
        â”‚   â””â”€â”€ å¤‡é€‰: AList API è·å–
        â”‚
        â”œâ”€â”€ æˆåŠŸ â”€â”€â–º è¿”å› 302 é‡å®šå‘åˆ°å¤¸å…‹ç›´é“¾
        â”‚
        â””â”€â”€ å¤±è´¥ â”€â”€â–º åˆ‡æ¢åˆ° WebDAV å…œåº•
                     â””â”€â”€ è¿”å› 302 é‡å®šå‘åˆ° WebDAV URL
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|------|
| STRM ç”Ÿæˆå™¨ | `strm_generator.py` | ç”Ÿæˆ STRM æ–‡ä»¶ |
| 302 ä»£ç†æœåŠ¡ | `proxy_service.py` | è·å–ç›´é“¾å¹¶ 302 é‡å®šå‘ |
| ç›´é“¾è·å–å™¨ | `link_resolver.py` (æ–°å»º) | ç»Ÿä¸€ç›´é“¾è·å–ï¼Œæ”¯æŒå¤šæº |
| WebDAV å…œåº• | `webdav_fallback.py` (æ–°å»º) | 302 å¤±è´¥æ—¶çš„å…œåº•å¤„ç† |
| Token åˆ·æ–°å™¨ | `token_refresher.py` (æ–°å»º) | æ£€æµ‹å¹¶è‡ªåŠ¨åˆ·æ–° Token |

---

## ğŸ“– åˆ†é˜¶æ®µå®æ–½

### é˜¶æ®µ 1: ä¿®æ”¹ STRM ç”Ÿæˆé€»è¾‘ï¼ˆP0ï¼‰

**ç›®æ ‡**: STRM æ–‡ä»¶å†™å…¥æœ¬åœ°ä»£ç† URL è€Œéç›´é“¾

**ä¿®æ”¹æ–‡ä»¶**: `app/services/strm_generator.py`

**å˜æ›´ç‚¹**:
```python
# ä¿®æ”¹å‰ (line 193-211)
video_url = link.url  # ç›´æ¥ä½¿ç”¨ç›´é“¾ URL

# ä¿®æ”¹å
video_url = f"{self.base_url}/api/proxy/redirect/{file_id}"  # ä½¿ç”¨ä»£ç† URL
```

**æ–°å¢å‚æ•°**:
- `strm_url_mode`: é€‰æ‹© STRM å†…å®¹æ¨¡å¼
  - `redirect`: ä½¿ç”¨ 302 ä»£ç† URLï¼ˆé»˜è®¤ï¼‰
  - `stream`: ä½¿ç”¨æµä»£ç† URL
  - `direct`: ä½¿ç”¨ç›´é“¾ URLï¼ˆä¸æ¨èï¼‰

**éªŒè¯æ–¹æ³•**:
1. ç”Ÿæˆ STRM æ–‡ä»¶
2. æ£€æŸ¥æ–‡ä»¶å†…å®¹æ˜¯å¦ä¸ºä»£ç† URL
3. æµè§ˆå™¨è®¿é—®ä»£ç† URLï¼ŒéªŒè¯ 302 é‡å®šå‘

---

### é˜¶æ®µ 2: éªŒè¯ 302 ç›´é“¾è·å–ï¼ˆP0ï¼‰

**ç›®æ ‡**: ç¡®ä¿ç°æœ‰çš„ 302 ä»£ç† API å¯æ­£å¸¸å·¥ä½œ

**æµ‹è¯•æ¥å£**: 
- `GET /api/proxy/redirect/{file_id}` - åº”è¿”å› 302 é‡å®šå‘

**æµ‹è¯•æ­¥éª¤**:
1. ä»å¤¸å…‹ç½‘ç›˜è·å–ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ ID
2. è°ƒç”¨ `/api/proxy/redirect/{file_id}`
3. éªŒè¯è¿”å› 302 çŠ¶æ€ç 
4. éªŒè¯ Location header ä¸ºæœ‰æ•ˆçš„å¤¸å…‹ç›´é“¾

**éªŒè¯å‘½ä»¤**:
```bash
curl -v "http://localhost:8000/api/proxy/redirect/{file_id}" 2>&1 | grep -E "Location|HTTP"
```

---

### é˜¶æ®µ 3: åˆ›å»ºç»Ÿä¸€ç›´é“¾è·å–å™¨ï¼ˆP0ï¼‰

**ç›®æ ‡**: åˆ›å»ºç»Ÿä¸€æ¥å£æ”¯æŒå¤šç§ç›´é“¾è·å–æ–¹å¼

**æ–°å»ºæ–‡ä»¶**: `app/services/link_resolver.py`

**åŠŸèƒ½**:
- ç»Ÿä¸€æ¥å£è·å–ç›´é“¾
- æ”¯æŒå¤¸å…‹ API ç›´æ¥è·å–
- æ”¯æŒ AList API è·å–
- é”™è¯¯å¤„ç†å’Œé‡è¯•

**æ¥å£è®¾è®¡**:
```python
class LinkResolver:
    async def resolve(self, file_id: str, path: str = None) -> ResolvedLink:
        """
        è§£ææ–‡ä»¶ç›´é“¾
        
        ä¼˜å…ˆçº§:
        1. å¤¸å…‹ API ç›´æ¥è·å–
        2. AList API è·å–
        """
        pass
    
    async def resolve_by_path(self, path: str) -> ResolvedLink:
        """æŒ‰è·¯å¾„è·å–ç›´é“¾"""
        pass
```

---

### é˜¶æ®µ 4: å®ç° WebDAV å…œåº•ï¼ˆP1ï¼‰

**ç›®æ ‡**: 302 å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ° WebDAV

**æ–°å»ºæ–‡ä»¶**: `app/services/webdav_fallback.py`

**è§¦å‘æ¡ä»¶**:
- å¤¸å…‹ API è¿”å›é”™è¯¯
- ç›´é“¾è¯·æ±‚è¶…æ—¶
- Token è¿‡æœŸä¸”åˆ·æ–°å¤±è´¥

**å…œåº•é€»è¾‘**:
```python
class WebDAVFallback:
    async def get_fallback_url(self, path: str) -> str:
        """
        è·å– WebDAV å…œåº• URL
        
        è¿”å›æ ¼å¼: http://webdav_host/dav/path/to/file.mp4
        """
        pass
```

**é…ç½®é¡¹** (config.yaml):
```yaml
webdav:
  enabled: true
  host: "http://localhost:5244"  # AList WebDAV åœ°å€
  mount_path: "/dav"
  fallback_enabled: true  # å¯ç”¨å…œåº•
```

---

### é˜¶æ®µ 5: Token è‡ªåŠ¨åˆ·æ–°ï¼ˆP1ï¼‰

**ç›®æ ‡**: æ£€æµ‹ Token è¿‡æœŸå¹¶è‡ªåŠ¨åˆ·æ–°

**æ–°å»ºæ–‡ä»¶**: `app/services/token_refresher.py`

**æœºåˆ¶**:
- åå°ä»»åŠ¡å®šæœŸæ£€æŸ¥ Token æœ‰æ•ˆæ€§
- è¯·æ±‚å¤±è´¥æ—¶è§¦å‘åˆ·æ–°
- åˆ·æ–°åé€šçŸ¥ç›¸å…³æœåŠ¡æ›´æ–°

**é…ç½®é¡¹**:
```yaml
quark:
  cookie: "..."
  token_check_interval: 3600  # Token æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
  auto_refresh: true  # è‡ªåŠ¨åˆ·æ–°
```

---

### é˜¶æ®µ 6: ä¿®æ”¹ä»£ç†è·¯ç”±æ”¯æŒå…œåº•ï¼ˆP1ï¼‰

**ç›®æ ‡**: `/api/proxy/redirect/{file_id}` æ”¯æŒè‡ªåŠ¨å…œåº•

**ä¿®æ”¹æ–‡ä»¶**: `app/api/proxy.py`

**å˜æ›´é€»è¾‘**:
```python
@router.get("/redirect/{file_id}")
async def redirect_302(file_id: str):
    try:
        # 1. å°è¯•è·å– 302 ç›´é“¾
        redirect_url = await link_resolver.resolve(file_id)
        return RedirectResponse(url=redirect_url, status_code=302)
    except Exception as e:
        # 2. å¤±è´¥æ—¶åˆ‡æ¢åˆ° WebDAV å…œåº•
        if webdav_fallback.enabled:
            fallback_url = await webdav_fallback.get_url(file_id)
            return RedirectResponse(url=fallback_url, status_code=302)
        raise
```

---

### é˜¶æ®µ 7: æŒ‰è·¯å¾„ç”Ÿæˆ STRMï¼ˆP1ï¼‰

**ç›®æ ‡**: æ”¯æŒæŒ‰å¤¸å…‹ç›®å½•è·¯å¾„æ‰¹é‡ç”Ÿæˆ STRM

**æ–°å¢ API**: `POST /api/strm/generate`

**è¯·æ±‚å‚æ•°**:
```json
{
  "remote_path": "/video/ç”µå½±",   // å¤¸å…‹ç›®å½•è·¯å¾„
  "local_path": "D:/strm/ç”µå½±",   // æœ¬åœ° STRM è¾“å‡ºè·¯å¾„
  "recursive": true,              // æ˜¯å¦é€’å½’
  "base_url": "http://192.168.1.100:8000"  // ä»£ç† URL åŸºç¡€åœ°å€
}
```

**å“åº”**:
```json
{
  "status": "success",
  "generated": 150,
  "skipped": 10,
  "failed": 2,
  "files": [...]
}
```

---

## ğŸ“¦ æ–‡ä»¶å˜æ›´æ¸…å•

### ä¿®æ”¹æ–‡ä»¶
| æ–‡ä»¶ | å˜æ›´è¯´æ˜ |
|------|----------|
| `app/services/strm_generator.py` | ä¿®æ”¹ STRM å†…å®¹ä¸ºä»£ç† URL |
| `app/api/proxy.py` | æ·»åŠ å…œåº•é€»è¾‘ |
| `app/services/proxy_service.py` | é›†æˆ LinkResolver |

### æ–°å»ºæ–‡ä»¶
| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|----------|
| `app/services/link_resolver.py` | ç»Ÿä¸€ç›´é“¾è·å–å™¨ |
| `app/services/webdav_fallback.py` | WebDAV å…œåº•æ¨¡å— |
| `app/services/token_refresher.py` | Token è‡ªåŠ¨åˆ·æ–° |
| `app/api/strm_v2.py` | æ–°ç‰ˆ STRM ç”Ÿæˆ API |

### é…ç½®å˜æ›´
| æ–‡ä»¶ | å˜æ›´è¯´æ˜ |
|------|----------|
| `config.yaml` | æ·»åŠ  WebDAV å…œåº•é…ç½®ã€Token åˆ·æ–°é…ç½® |

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] STRM æ–‡ä»¶å†…å®¹ä¸ºä»£ç† URL
- [ ] è®¿é—®ä»£ç† URL è¿”å› 302 é‡å®šå‘
- [ ] é‡å®šå‘ç›®æ ‡ä¸ºæœ‰æ•ˆçš„å¤¸å…‹ç›´é“¾
- [ ] Emby å¯æ­£å¸¸è¯†åˆ«å’Œæ’­æ”¾ STRM
- [ ] 302 å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ° WebDAV
- [ ] Token è¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°

### æ€§èƒ½éªŒæ”¶
- [ ] ç›´é“¾è·å–å“åº”æ—¶é—´ < 3s
- [ ] ç›´é“¾ç¼“å­˜å‘½ä¸­ç‡ > 80%
- [ ] æ’­æ”¾å¯åŠ¨æ—¶é—´ < 5s

---

## ğŸš€ æ‰§è¡Œé¡ºåº

1. **é˜¶æ®µ 1**: ä¿®æ”¹ STRM ç”Ÿæˆé€»è¾‘ â¬…ï¸ **ä»è¿™é‡Œå¼€å§‹**
2. **é˜¶æ®µ 2**: éªŒè¯ 302 ç›´é“¾è·å–
3. **é˜¶æ®µ 3**: åˆ›å»ºç»Ÿä¸€ç›´é“¾è·å–å™¨
4. **é˜¶æ®µ 4**: å®ç° WebDAV å…œåº•
5. **é˜¶æ®µ 5**: Token è‡ªåŠ¨åˆ·æ–°
6. **é˜¶æ®µ 6**: ä¿®æ”¹ä»£ç†è·¯ç”±æ”¯æŒå…œåº•
7. **é˜¶æ®µ 7**: æŒ‰è·¯å¾„ç”Ÿæˆ STRM API

---

**åˆ›å»ºè€…**: Architect Agent  
**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-02-04
