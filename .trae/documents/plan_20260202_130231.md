# P4阶段开发实施计划

## 目标
完成Emby深度联动、播放测试优化和消息通知系统的集成，实现刮削→通知→Emby刷新→播放的完整闭环。

## 已有配置
- **Emby地址**: http://192.168.100.66:18096/
- **API密钥**: 0be957f3e00f4133b550efa05df5b3bc

## 任务分解

### 任务1: Emby深度联动 - 刮削后自动刷新库
**文件修改**:
- `app/services/emby_service.py` - 添加 `refresh_library()` 方法
- `app/services/scrape_service.py` - 在任务完成时调用Emby刷新

**具体实现**:
1. 在 `EmbyService` 中实现 `refresh_library(library_id)` 方法，调用Emby API触发媒体库刷新
2. 在 `ScrapeService._process_job()` 完成后，自动调用Emby刷新
3. 从config.yaml读取Emby配置（已配置：http://192.168.100.66:18096/）

### 任务2: 播放测试与代理优化
**文件修改**:
- `app/services/emby_proxy_service.py` - 添加直链有效性预检和Failover机制
- `app/api/emby.py` - 优化302重定向端点

**具体实现**:
1. 在 `EmbyProxyService` 中添加 `_check_url_alive()` 方法验证直链有效性
2. 实现Failover机制：直链失败时降级到本地代理
3. 优化 `proxy_stream_request()` 方法，返回307重定向
4. 添加播放测试API端点

### 任务3: 消息通知系统完善
**文件修改**:
- `config.yaml` - 添加通知配置示例
- `app/services/scrape_service.py` - 确保通知埋点完整

**具体实现**:
1. 在config.yaml中添加notification配置示例（Telegram/WeChat）
2. 验证刮削服务中的通知调用（TASK_STARTED/TASK_COMPLETED/TASK_FAILED）
3. 添加Emby刷新完成的通知

## 验收标准
1. 刮削任务完成后，Emby对应媒体库自动进入扫描状态
2. Telegram能收到刮削完成/失败通知
3. Emby扫描完毕后，能收到"新媒体入库"通知
4. 在Emby点击播放，能正常302重定向到网盘直链

## 风险点
- Emby API调用可能失败，需要错误处理
- 直链可能过期，需要Failover机制
- 通知渠道配置错误导致发送失败

## 回滚方案
```bash
git reset --hard <commit hash>
```