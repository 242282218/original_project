# 阶段六：系统配置功能优化实施计划

## 目标
统一系统配置持久化处理，将 Telegram 配置从前端 localStorage 迁移到后端 config.yaml，删除冗余的 ConfigManager 类。

## 实施步骤

### 第一步：更新配置模型 (P0)
**文件**: `app/config/settings.py`
- 添加 `TelegramConfig` 模型（enabled, bot_token, chat_id, proxy, events）
- 添加 `WeChatConfig` 模型（enabled, provider, send_key）
- 更新 `AppConfig` 模型，添加 telegram 和 wechat 字段

### 第二步：创建统一配置服务 (P0)
**文件**: `app/services/config_service.py` (新建)
- 实现 `ConfigService` 单例类
- 提供线程安全的配置读写方法
- 实现原子性保存（临时文件 → 备份 → 原子替换）
- 添加配置变更通知机制

### 第三步：更新 API 接口 (P0)
**文件**: `app/api/system_config.py`
- 改用 `ConfigService` 替代直接操作 `AppConfig`
- 添加 Telegram 测试接口 `/api/system-config/test-telegram`

### 第四步：更新前端 API 类型 (P1)
**文件**: `web/src/api/config.ts`
- 添加 `TelegramConfig` 和 `WeChatConfig` 接口定义
- 更新 `AppConfig` 接口

### 第五步：更新前端配置页面 (P0)
**文件**: `web/src/views/ConfigView.vue`
- 移除 localStorage 相关代码（loadTelegramConfig, saveTelegramConfig）
- Telegram 配置改为从后端 API 读取和保存
- 调用后端测试接口进行 Telegram 测试

### 第六步：更新 SDK 配置 (P1)
**文件**: `app/core/sdk_config.py`
- 改用 `ConfigService` 获取 API 密钥

### 第七步：更新通知服务 (P1)
**文件**: `app/services/notification_service.py`
- 从 `ConfigService` 读取 Telegram 基础配置
- 数据库仅存储动态渠道和规则配置

### 第八步：删除冗余代码 (P1)
**文件**: `app/core/config_manager.py`
- 删除整个文件
- 更新所有引用（sdk_config.py）

### 第九步：更新主应用入口 (P2)
**文件**: `app/main.py`
- 使用 `ConfigService` 初始化配置

### 第十步：添加配置迁移工具 (P1)
**文件**: `web/src/utils/migrate-config.ts` (新建)
- 实现一次性 localStorage → 后端配置迁移逻辑
- 在应用启动时执行

## 约束范围
**仅修改以下文件：**
- `app/config/settings.py`
- `app/services/config_service.py` (新建)
- `app/api/system_config.py`
- `web/src/api/config.ts`
- `web/src/views/ConfigView.vue`
- `app/core/sdk_config.py`
- `app/services/notification_service.py`
- `app/core/config_manager.py` (删除)
- `app/main.py`
- `web/src/utils/migrate-config.ts` (新建)
- `web/src/main.ts` (添加迁移调用)

**禁止修改：** 未列出的任何文件

## 风险点
1. Telegram 配置迁移可能导致用户配置丢失
2. 删除 ConfigManager 可能影响其他模块
3. 并发配置写入可能导致数据损坏

## 回滚方案
```bash
git reset --hard <commit hash>
```

## 验收标准
- [ ] config.yaml 包含完整的 Telegram 配置结构
- [ ] 前端 ConfigView.vue 不再使用 localStorage 保存 Telegram 配置
- [ ] 后端 NotificationService 能正确读取 Telegram 配置并发送通知
- [ ] 配置保存后刷新页面，数据保持一致
- [ ] 现有功能无回归问题