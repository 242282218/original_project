# 阶段六验收测试计划

## 测试目标
验证系统配置优化功能，确保：
1. Telegram 配置正确持久化到 config.yaml
2. 前端不再使用 localStorage
3. 配置服务线程安全、原子保存
4. 通知服务能正确读取配置
5. 现有功能无回归

## 测试步骤

### 第一步：后端单元测试 (P0)

#### 1.1 配置模型测试
**文件**: `tests/unit/test_config_models.py` (新建)

测试内容：
- `test_telegram_config_default_values()` - 测试 TelegramConfig 默认值
- `test_wechat_config_default_values()` - 测试 WeChatConfig 默认值
- `test_appconfig_telegram_integration()` - 测试 AppConfig 集成 Telegram 配置
- `test_yaml_serialization()` - 测试 YAML 序列化/反序列化

#### 1.2 配置服务测试
**文件**: `tests/unit/test_config_service.py` (新建)

测试内容：
- `test_singleton()` - 测试 ConfigService 单例模式
- `test_atomic_save()` - 测试原子性保存
- `test_backup_on_error()` - 测试错误时备份恢复
- `test_concurrent_access()` - 测试并发访问线程安全

### 第二步：API 集成测试 (P0)

#### 2.1 系统配置 API 测试
**文件**: `tests/integration/test_system_config_api.py` (新建)

测试内容：
- `test_get_config()` - 测试获取配置 API
- `test_update_config()` - 测试更新配置 API
- `test_update_telegram_config()` - 测试更新 Telegram 配置
- `test_test_telegram_endpoint()` - 测试 Telegram 测试接口
- `test_invalid_config()` - 测试无效配置验证

### 第三步：前端 E2E 测试 (P0)

#### 3.1 配置页面测试
**文件**: `web/e2e/tests/config.spec.ts` (新建)

测试内容：
- `test_load_config_page()` - 测试配置页面加载
- `test_telegram_config_display()` - 测试 Telegram 配置显示
- `test_save_telegram_config()` - 测试保存 Telegram 配置
- `test_config_persistence()` - 测试刷新后配置保持
- `test_test_telegram_push()` - 测试 Telegram 测试推送功能

### 第四步：配置迁移测试 (P1)

#### 4.1 迁移工具测试
**文件**: `tests/unit/test_config_migration.py` (新建)

测试内容：
- `test_migrate_from_localstorage()` - 测试 localStorage 迁移逻辑
- `test_migration_skip_if_done()` - 测试已迁移时跳过
- `test_migration_error_handling()` - 测试迁移失败处理

### 第五步：回归测试 (P1)

#### 5.1 现有功能测试
**文件**: `tests/regression/test_existing_features.py` (新建)

测试内容：
- `test_notification_service_still_works()` - 测试通知服务兼容性
- `test_api_routes_still_works()` - 测试现有 API 路由
- `test_dashboard_still_works()` - 测试仪表盘功能

## 执行命令

```bash
# 后端测试
pytest tests/unit/test_config_models.py -v
pytest tests/unit/test_config_service.py -v
pytest tests/integration/test_system_config_api.py -v

# 前端测试
cd web && npx playwright test e2e/tests/config.spec.ts

# 回归测试
pytest tests/regression/test_existing_features.py -v
```

## 验收标准

- [ ] 所有单元测试通过
- [ ] 所有集成测试通过
- [ ] 所有 E2E 测试通过
- [ ] 配置模型测试覆盖率 > 80%
- [ ] 现有功能无回归

## 风险点

1. ConfigService 单例模式可能导致测试隔离问题
2. 文件 I/O 测试可能不稳定
3. E2E 测试需要后端服务运行
4. 迁移测试需要模拟 localStorage