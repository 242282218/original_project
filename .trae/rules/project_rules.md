# .trae/rules/project_rules.md（项目规则 / 当前项目）

## 0. 规则优先级
- 本项目规则优先于 user_rules.md；冲突以本文件为准。

---

## 1. 执行前置条件（硬门禁：缺一即停止）
在响应任何工程相关请求前，必须先输出：
1) 【本轮唯一执行 Agent】（本轮只允许一个 Agent）  
2) 【已阅读文件路径清单】至少包含：
   - ai/rules/agent.md（允许在上级目录；必须先搜索定位）
   - ai/runner.md
   - ai/state/plan.md
3) 若任一文件缺失：立即停止并输出 **“前置条件不足”**  
4) 在完成上述检查前：不得生成任何代码或方案（违者视为 FAIL）

---

## 2. 单轮多阶段任务（强制 Skill 流程）
0) 多阶段任务：必须使用用户指定的 Skill/集合；每步输出【真实日志 + 操作 + 校验】  
1) 禁止绕过 Skill；未按步执行/日志不真实/无校验结果 → FAIL  
2) 自动重试限制：失败一次必须 FAIL 并停止，等待人工决策

---

## 3. 输出模板（项目强制字段）
除 user_rules.md 模板外，本项目额外强制：
- 【已读文件】必须包含上述 3 个路径（或明确指出缺失并停止）  
- 【状态】必须出现（PASS/FAIL）  
- 【回滚】有改动必填（无改动写 “无”）

---

## 4. 测试与验证（项目偏好）
- Verify 阶段优先 Python 验证；尽量少用终端命令  
- 终端命令出现超时/卡死：立即退出并 FAIL  
- 修复类任务必须包含：复现 → 修复 → 同路径回归验证（必要时补测试）

---

## 5. 代码与合规（项目强制）
- 生成/修改函数必须有函数级注释/Docstring（用途/输入/输出/副作用）  
- 严禁硬编码密钥；输入校验；日志脱敏；最小权限  
- 大规模改动前必须提醒 git 备份并要求确认是否继续（未确认不得执行）

---

## 6. 测试执行（项目强制）
- 仅允许使用 `scripts/run_tests.py`（配置文件：`ai/test_config.yaml`）
- 禁止直接运行 pytest/npm test 或进入交互式 shell
- 日志固定输出到 `logs/test/`（summary/stdout/stderr/junit）
